<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kita usahakan extract metadata penelitian itu</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #f7f9fc;
            --surface: #ffffff;
            --text: #0e1726;
            --muted: #5b6b8c;
            --primary: #00e677a3; /* neon green */
            --primary-600: #00c853; /* deeper neon green */
            --accent: #b9f26998;  /* lime accent */
            --glow: rgba(0, 200, 83, 0.45);
            --glow-strong: rgba(0, 230, 118, 0.7);
        }

        html, body { height: 100%; }
        body {
            padding: 30px 0;
            background:
                        /* subtle grid */
                        linear-gradient(to right, rgba(0,200,83,0.06) 1px, transparent 1px),
                        linear-gradient(to bottom, rgba(0,200,83,0.06) 1px, transparent 1px),
                        /* soft radial tints */
                        radial-gradient(1200px 800px at 10% -10%, rgba(0,230,118,0.12), transparent 60%),
                        radial-gradient(1000px 700px at 110% 10%, rgba(184,242,105,0.12), transparent 60%),
                        var(--bg);
            background-size: 40px 40px, 40px 40px, auto, auto, auto;
            color: var(--text);
            font-family: 'Sora', 'Poppins', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', sans-serif;
            position: relative;
            overflow-x: hidden;
        }
        .container {
            max-width: 1200px;
        }
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(14, 23, 38, 0.07);
            margin-bottom: 30px;
            background: var(--surface);
            border: 1px solid rgba(61, 214, 245, 0.08);
            transition: transform .25s ease, box-shadow .25s ease, border-color .25s ease;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 26px rgba(14, 23, 38, 0.12), 0 0 0 2px var(--glow) inset;
            border-color: rgba(61, 214, 245, 0.25);
        }
        .card-header {
            background: linear-gradient(90deg, var(--primary-600), var(--accent));
            color: #06131a;
            font-weight: bold;
            border-radius: 10px 10px 0 0 !important;
            box-shadow: 0 0 0 1px rgba(255,255,255,.25) inset, 0 0 24px 0 rgba(0,230,118,.25);
        }
        .form-control {
            padding: 12px;
            border-radius: 5px;
            border: 1px solid rgba(14, 23, 38, 0.12);
            transition: box-shadow .2s ease, border-color .2s ease, transform .15s ease;
        }
        .form-control:focus {
            border-color: var(--primary-600);
            box-shadow: 0 0 0 .2rem rgba(61, 214, 245, 0.25);
            transform: translateY(-1px);
        }
        .btn-primary {
            background: linear-gradient(90deg, var(--primary-600), var(--accent));
            border: none;
            padding: 12px 25px;
            font-weight: 600;
            color: #06131a;
            box-shadow: 0 6px 14px rgba(0, 230, 118, 0.25);
            transition: transform .2s ease, box-shadow .2s ease;
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 22px rgba(0, 230, 118, 0.35);
        }
        .table th {
            background-color: #f8f9fa;
            vertical-align: middle;
        }
        .table tbody tr {
            transition: transform .18s ease, box-shadow .18s ease, background-color .18s ease;
        }
        .table tbody tr:hover {
            background: linear-gradient(90deg, rgba(0,230,118,0.10), rgba(184,242,105,0.10));
            transform: translateX(2px);
            box-shadow: 0 0 0 1px var(--glow) inset;
        }
        a:hover { text-decoration: none; }
        a, .nav-link, .btn, .card, .form-control, .table tbody tr { will-change: transform; }
        .preview-frame {
            width: 100%;
            height: 600px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            margin-top: 10px;
            transition: box-shadow .2s ease;
        }
        .preview-frame:hover {
            box-shadow: 0 0 0 2px var(--glow);
        }
        /* Make the table full width */
        .table {
            width: 100%;
        }
        /* Improve spacing in table cells */
        .table td, .table th {
            padding: 0.75rem;
            vertical-align: top;
        }
        /* Improve readability of abstracts */
        .card-text {
            white-space: pre-line;
            text-align: justify;
            line-height: 1.6;
        }
        /* Style tabs */
        .nav-tabs .nav-link { color: var(--primary-600); transition: color .2s ease, box-shadow .2s ease; }
        .nav-tabs .nav-link:hover { color: #2aa7c1; }
        .nav-tabs .nav-link.active { color: #293042; font-weight: 700; box-shadow: 0 2px 0 0 var(--primary-600); }
        
        /* Drag and drop styling */
        body.drag-over {
            background-color: rgba(0,230,118,0.06);
            border: 3px dashed var(--primary-600);
        }
        
        .drag-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 230, 118, 0.08);
            display: none;
            z-index: 9999;
            pointer-events: none;
        }
        
        .drag-overlay.active {
            display: block;
        }
        
        .drag-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(90deg, var(--primary-600), var(--accent));
            color: #06131a;
            padding: 20px 40px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            box-shadow: 0 8px 28px rgba(0, 230, 118, 0.35);
        }

        /* Loading animations */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg, rgba(255,255,255,0.92), rgba(255,255,255,0.88));
            display: none;
            z-index: 10000;
            backdrop-filter: blur(5px);
        }
         /* heading with GTA-6-like gradient */
        h1 {
            font-weight: 700;
            background: linear-gradient(90deg, var(--accent-2), var(--accent-1) 60%, var(--accent-3));
            text-shadow: 0 0 0 rgba(0,0,0,0);
            color: #010302a9;
        }


        .loading-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .loading-content {
            text-align: center;
            padding: 32px 28px;
            background: var(--surface);
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(14, 23, 38, 0.15), 0 0 0 1px rgba(0, 230, 118, 0.12) inset;
            max-width: 420px;
        }

        /* Neon ring loader */
        .loading-spinner {
            --size: 64px;
            width: var(--size);
            height: var(--size);
            margin: 0 auto 20px;
            border-radius: 50%;
            background:
                conic-gradient(from 0deg, var(--primary) 0 25%, rgba(184,242,105,0.95) 25% 50%, rgba(0,230,118,0.7) 50% 75%, rgba(184,242,105,0.6) 75% 100%);
            -webkit-mask: radial-gradient(farthest-side, transparent calc(50% - 6px), #000 0);
                    mask: radial-gradient(farthest-side, transparent calc(50% - 6px), #000 0);
            animation: rotate 1.2s linear infinite;
            box-shadow: 0 0 30px var(--glow-strong);
        }
        @keyframes rotate { to { transform: rotate(1turn); } }

        .loading-text {
            color: var(--primary-600);
            font-weight: 600;
            margin-bottom: 10px;
        }

        .loading-steps {
            font-size: 14px;
            color: var(--muted);
        }

        /* Skeleton loading for metadata table */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 4px;
            height: 20px;
            margin-bottom: 10px;
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        .skeleton-row {
            display: table-row;
        }

        .skeleton-cell {
            display: table-cell;
            padding: 0.75rem;
            vertical-align: top;
        }

        /* Fade in animation for results */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Progress bar */
        .progress-container {
            width: 100%;
            height: 6px;
            background-color: #f0f0f0;
            border-radius: 3px;
            margin: 15px 0;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-600), var(--accent));
            border-radius: 3px;
            width: 0%;
            transition: width 0.3s ease;
            position: relative;
            box-shadow: 0 0 14px rgba(0, 230, 118, 0.45);
        }

        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: progressShine 2s infinite;
        }

        @keyframes progressShine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* Particles background layer */
        #particles-js {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1; pointer-events: none; opacity: 0.45;
        }

        /* Moving glow blobs (subtle, behind content) */
        .glow-blobs { position: fixed; inset: -10% -10%; z-index: 0; pointer-events: none; overflow: hidden; }
        .glow-blobs span {
            position: absolute; display: block; border-radius: 50%;
            filter: blur(40px); opacity: 0.35; will-change: transform;
            mix-blend-mode: screen;
            background: radial-gradient(circle at 30% 30%, var(--c1), transparent 60%);
            animation: blobDrift var(--dur, 12s) ease-in-out infinite alternate;
        }
    .glow-blobs span:nth-child(1){ --c1: rgba(0,230,118,0.85); width: 38vmax; height: 38vmax; top: 5%; left: -8%; --dur: 16s; transform: translate3d(0,0,0); }
    .glow-blobs span:nth-child(2){ --c1: rgba(184,242,105,0.85); width: 30vmax; height: 30vmax; top: 60%; right: -6%; --dur: 14s; }
    .glow-blobs span:nth-child(3){ --c1: rgba(0,200,83,0.7); width: 26vmax; height: 26vmax; bottom: -6%; left: 20%; --dur: 18s; }
    .glow-blobs span:nth-child(4){ --c1: rgba(184,242,105,0.6); width: 22vmax; height: 22vmax; top: 18%; right: 20%; --dur: 20s; }
        @keyframes blobDrift {
            0%   { transform: translate3d(0px, 0px, 0) scale(1); }
            50%  { transform: translate3d(30px, -20px, 0) scale(1.05); }
            100% { transform: translate3d(-25px, 25px, 0) scale(1.02); }
        }

        /* Intro overlay */
        .intro-overlay {
            position: fixed; inset: 0; z-index: 11000;
            display: none; align-items: center; justify-content: center;
            background: radial-gradient(800px 500px at 50% -10%, rgba(61,214,245,0.15), rgba(255,255,255,0.95) 60%);
            backdrop-filter: blur(4px);
        }
        .intro-overlay.active { display: flex; animation: introFade .8s ease forwards; }
        @keyframes introFade { from { opacity: 0; } to { opacity: 1; } }
        .intro-card {
            background: var(--surface);
            border-radius: 16px;
            padding: 24px 28px;
            border: 1px solid rgba(61, 214, 245, 0.25);
            box-shadow: 0 10px 30px rgba(14, 23, 38, 0.18), 0 0 24px rgba(61,214,245,0.28);
            text-align: center;
            transform: translateY(10px);
            animation: liftIn .7s ease .2s forwards;
        }
        @keyframes liftIn { to { transform: translateY(0); } }
        .intro-title { font-weight: 700; font-size: 24px; color: #0b1623; }
        .intro-sub { color: var(--muted); font-size: 14px; }
        .intro-line {
            height: 3px; width: 180px; margin: 14px auto 18px; border-radius: 999px;
            background: linear-gradient(90deg, var(--primary-600), var(--accent));
            box-shadow: 0 0 16px var(--glow);
        }

        /* Particle assemble effect helpers */
        .assemble-hide { opacity: 0; transform: translateY(6px) scale(0.985); }
    .assemble-show { opacity: 1; transform: none; transition: opacity .25s ease, transform .25s ease; }
        .assemble-canvas {
            position: absolute; pointer-events: none; z-index: 9000;
            filter: drop-shadow(0 0 6px rgba(0,230,118,.35));
        }
    </style>
</head>
<body>


    <!-- Subtle animated glow blobs -->
    <div class="glow-blobs" aria-hidden="true">
        <span></span>
        <span></span>
        <span></span>
        <span></span>
    </div>

    <!-- Intro overlay (first visit) -->
    <div class="intro-overlay" id="introOverlay" aria-hidden="true">
        <div class="intro-card">
            <div class="intro-title">Selamat welkom</div>
            <div class="intro-line"></div>
            <div class="intro-sub">Letsgoo mainkan . btw thx github copilot yang sudah menemani dalam pembuatan kode ini XD✨</div>
        </div>
    </div>
    <div class="container">
        <h1 class="text-center mb-4">Perjalanan Mempermudah Verifikasi</h1>
        
        <!-- Error Alert Container -->
        <div id="error-container" class="alert alert-danger mt-3" style="display: none;">
            <span id="error-message"></span>
        </div>

        <!-- Results Container -->
        <div id="results-container" style="display: none;">
            <!-- Display note about metadata source if from citation -->
            <div id="citation-notice" class="alert alert-info mb-4" style="display: none;">
                <i class="bi bi-info-circle me-2"></i>
                <strong>Sumber Metadata:</strong> Metadata ini diekstrak dari meta tag citation karena metadata Dublin Core tidak tersedia.
            </div>
            
            <!-- Display note about Wayback Machine if applicable -->
            <div id="wayback-notice" class="alert alert-warning mb-4" style="display: none;">
                <i class="bi bi-clock-history me-2"></i>
                <strong>Pemberitahuan Arsip:</strong> <span id="wayback-message"></span>
                <a id="wayback-link" href="#" target="_blank" class="alert-link">Lihat versi arsip</a>
            </div>
            
            <!-- Main Metadata Card -->
            <div class="card mb-4 fade-in">
                <div class="card-header">
                    <i class="bi bi-info-circle-fill me-2"></i>Metadata Jurnal
                </div>
                <div class="card-body">
                    <table class="table table-striped" id="metadata-table">
                        <tbody id="metadata-tbody">
                            <!-- Dynamic content will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
               <!-- Sinta Journal Info (async) -->
        <div class="card mb-4 fade-in" id="sinta-card" style="display: none;">
                <div class="card-header">
                    <i class="bi bi-award me-2"></i>Info Jurnal Sinta
                </div>
                <div class="card-body">
            <div id="sinta-loading" class="align-items-center" style="display: none;">
                        <div class="spinner-border spinner-border-sm text-success me-2" role="status"></div>
                        <span>Memuat info Sinta...</span>
                    </div>
                    <div id="sinta-error" class="text-danger" style="display: none;"></div>
                    <div id="sinta-content" style="display: none;">
                        <div class="mb-2">
                            <strong>Nama:</strong>
                            <span id="sinta-name" class="ms-1"></span>
                        </div>
                        <div class="mb-2">
                            <strong>Website:</strong>
                            <a id="sinta-website" class="ms-1" href="#" target="_blank" rel="noopener noreferrer"></a>
                        </div>
                        <div class="mb-2">
                            <strong>Riwayat Akreditasi:</strong>
                            <div id="sinta-accreditation-history" class="mt-2"></div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- SCImago Journal Info (async) -->
            <div class="card mb-4 fade-in" id="scimago-card" style="display: none;">
                <div class="card-header">
                    <i class="bi bi-bar-chart-fill me-2"></i>Info Jurnal SCImago
                </div>
                <div class="card-body">
                    <div id="scimago-loading" class="align-items-center" style="display: none;">
                        <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                        <span>Memuat info SCImago...</span>
                    </div>
                    <div id="scimago-error" class="text-danger" style="display: none;"></div>
                    <div id="scimago-content" style="display: none;">
                        <div class="mb-2 d-flex align-items-center">
                            <img id="scimago-img" src="" alt="SCImago Logo" style="height:40px;width:auto;max-width:80px;" class="me-3 d-none"/>
                            <div>
                                <strong>Nama:</strong> <span id="scimago-name"></span><br>
                                <strong>Penerbit:</strong> <span id="scimago-publisher"></span><br>
                                <strong>Negara:</strong> <span id="scimago-country"></span><br>
                                <strong>Tipe Publikasi:</strong> <span id="scimago-type"></span><br>
                                <strong>Homepage:</strong> <a id="scimago-homepage" href="#" target="_blank"></a>
                            </div>
                        </div>
                        <div class="mb-2">
                            <strong>Quartile per Tahun:</strong>
                            <div id="scimago-quartiles" class="mt-2"></div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Additional Metadata Card -->
            <div class="card mb-4 fade-in">
                <div class="card-header">
                    <i class="bi bi-file-text me-2"></i>Informasi Tambahan
                </div>
                <div class="card-body" id="additional-info">
                    <!-- Dynamic content will be inserted here -->
                </div>
            </div>

            <!-- Journal Preview Card -->
            <div class="card mb-4 fade-in">
                <div class="card-header">
                    <i class="bi bi-globe me-2"></i>Pratinjau Website Jurnal
                </div>
                <div class="card-body">
                    <iframe id="preview-frame" class="preview-frame" title="Journal Preview" style="display: none;"></iframe>
                    <p id="no-preview" style="display: none;">Pratinjau tidak tersedia</p>
                </div>
            </div>
            
        </div>

         
        <!-- Welcome Message (when no results) -->
        <div id="welcome-message" class="alert alert-info mb-4">
            <i class="bi bi-info-circle-fill me-2"></i> 
            Silakan masukkan URL jurnal atau tempelkan konten HTML menggunakan formulir di bawah ini. Metadata yang diekstrak akan muncul di sini.
            <br>
            <strong>Tips:</strong> Anda juga dapat menekan <kbd>Ctrl+V</kbd> di mana saja pada halaman untuk menempel dan mencari secara otomatis, atau <strong>seret dan lepas</strong> tautan langsung ke halaman!
        </div>
        <!-- Input Form at the bottom -->
        <div class="card mt-4">
            <div class="card-header bg-secondary text-white">
                <i class="bi bi-input-cursor me-2"></i>Input URL Jurnal atau HTML
            </div>
            <div class="card-body">
                <ul class="nav nav-tabs" id="inputTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="url-tab" data-bs-toggle="tab" data-bs-target="#url-input" type="button" role="tab">Input URL</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="html-tab" data-bs-toggle="tab" data-bs-target="#html-input" type="button" role="tab">Tempel HTML</button>
                    </li>
                </ul>
                
                <div class="tab-content mt-3" id="inputTabContent">
                    <!-- URL Input Tab -->
                    <div class="tab-pane fade show active" id="url-input" role="tabpanel">
                        <form id="url-form">
                            <div class="mb-3">
                                <input type="text" class="form-control" name="journal_url" id="journal_url" 
                                    placeholder="Masukkan URL artikel jurnal" required>
                            </div>
                            <button type="submit" class="btn btn-primary" id="url-submit-btn">
                                <span class="btn-text">Ekstrak Metadata</span>
                                <span class="btn-spinner spinner-border spinner-border-sm ms-2" style="display: none;"></span>
                            </button>
                        </form>
                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="bi bi-info-circle"></i> Jika Anda mendapatkan error 403 Forbidden, kami akan mencoba mengambil konten dari Web Archive (Wayback Machine).
                                Jika itu gagal, Anda bisa mencoba menggunakan opsi "Tempel HTML" di bawah ini.
                            </small>
                        </div>
                    </div>
                    
                    <!-- HTML Input Tab -->
                    <div class="tab-pane fade" id="html-input" role="tabpanel">
                        <form id="html-form">
                            <div class="mb-3">
                                <label for="display_url" class="form-label">URL Tampilan (opsional)</label>
                                <input type="text" class="form-control" name="display_url" id="display_url" 
                                    placeholder="Masukkan URL untuk tampilan (opsional)">
                            </div>
                            <div class="mb-3">
                                <label for="html_content" class="form-label">Konten HTML</label>
                                <textarea class="form-control" name="html_content" id="html_content" 
                                    rows="10" placeholder="Tempelkan konten HTML di sini" required></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary" id="html-submit-btn">
                                <span class="btn-text">Ekstrak Metadata</span>
                                <span class="btn-spinner spinner-border spinner-border-sm ms-2" style="display: none;"></span>
                            </button>
                        </form>
                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="bi bi-info-circle"></i> Untuk menggunakan opsi ini, kunjungi halaman jurnal di browser Anda, 
                                klik kanan di mana saja pada halaman, pilih "Lihat Sumber Halaman", salin semua HTML, dan tempelkan di sini.
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text" id="loadingText">Kita coba ekstrak metadata-nya...</div>
            <div class="progress-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div class="loading-steps" id="loadingSteps">Tunggu sebentar...</div>
        </div>
    </div>

    <!-- Drag and drop overlay -->
    <div class="drag-overlay" id="dragOverlay">
        <div class="drag-message">
            <i class="bi bi-link-45deg me-2"></i>
            Seret tautan ke sini untuk dicoba ekstrak isinya XD
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Particles.js CDN -->

    
    <script>
        // SPA State Management
        let currentJournalUrl = null;
        let currentHtmlContent = null;
        const SERVER_URL = "https://api-ekstrak-web-jurnal.atiohaidar.workers.dev";

        // DOM Elements
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loadingText = document.getElementById('loadingText');
        const loadingSteps = document.getElementById('loadingSteps');
        const progressBar = document.getElementById('progressBar');
        const errorContainer = document.getElementById('error-container');
        const errorMessage = document.getElementById('error-message');
        const resultsContainer = document.getElementById('results-container');
        const welcomeMessage = document.getElementById('welcome-message');
        const introOverlay = document.getElementById('introOverlay');

        // Loading steps
        const loadingStepsList = [
            'Initializing request...',
            'Fetching journal page...',
            'Parsing metadata...',
            'Processing Sinta links...',
            'Preparing results...'
        ];

        // Utilities
        const escapeHtml = (s) => String(s)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');

        function copyToClipboard(text) {
            try {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    return navigator.clipboard.writeText(text);
                }
            } catch (_) { /* ignore */ }
            return new Promise((resolve, reject) => {
                try {
                    const ta = document.createElement('textarea');
                    ta.value = text;
                    ta.style.position = 'fixed';
                    ta.style.opacity = '0';
                    document.body.appendChild(ta);
                    ta.focus();
                    ta.select();
                    const ok = document.execCommand('copy');
                    document.body.removeChild(ta);
                    ok ? resolve() : reject(new Error('Copy failed'));
                } catch (e) { reject(e); }
            });
        }

        document.addEventListener('click', async (ev) => {
            const btn = ev.target.closest('[data-copy]');
            if (!btn) return;
            const text = btn.getAttribute('data-copy') || '';
            const original = btn.innerHTML;
            try {
                await copyToClipboard(text);
                btn.innerHTML = '<i class="bi bi-clipboard-check"></i> Disalin';
            } catch (_) {
                btn.innerHTML = '<i class="bi bi-x-circle"></i> Gagal';
            } finally {
                setTimeout(() => btn.innerHTML = original, 1200);
            }
        });

        // Intro overlay only on first visit of the session
        document.addEventListener('DOMContentLoaded', () => {
            try {
                const seen = sessionStorage.getItem('introSeen');
                if (!seen) {
                    introOverlay.classList.add('active');
                    setTimeout(() => {
                        introOverlay.style.transition = 'opacity .6s ease, visibility .6s ease';
                        introOverlay.style.opacity = '0';
                        introOverlay.style.visibility = 'hidden';
                        setTimeout(() => introOverlay.remove(), 700);
                    }, 1600);
                    sessionStorage.setItem('introSeen', '1');
                }
            } catch (_) { /* ignore storage errors */ }
        });

        // Show loading with animated steps
        function showLoading() {
            loadingOverlay.classList.add('active');
            progressBar.style.width = '0%';
            let step = 0;
            const stepInterval = setInterval(() => {
                if (step < loadingStepsList.length) {
                    loadingSteps.textContent = loadingStepsList[step];
                    progressBar.style.width = `${(step + 1) * 20}%`;
                    step++;
                } else {
                    clearInterval(stepInterval);
                    loadingSteps.textContent = 'Almost done...';
                    progressBar.style.width = '90%';
                }
            }, 800);
        }

        // Hide loading
        function hideLoading() {
            setTimeout(() => {
                progressBar.style.width = '100%';
                setTimeout(() => {
                    loadingOverlay.classList.remove('active');
                }, 300);
            }, 200);
        }

        // Show error message
        function showError(message) {
            errorMessage.textContent = message;
            errorContainer.style.display = 'block';
            resultsContainer.style.display = 'none';
            welcomeMessage.style.display = 'none';
            errorContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // Hide error message
        function hideError() {
            errorContainer.style.display = 'none';
        }

        // API call function
        async function callAPI(endpoint, data) {
            try {
                const url = `${SERVER_URL}${endpoint}`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const textResponse = await response.text();
                    throw new Error(`Server returned non-JSON response: ${textResponse.substring(0, 100)}`);
                }
                const result = await response.json();
                if (!response.ok) {
                    throw new Error(result.error || `HTTP error! status: ${response.status}`);
                }
                return result;
            } catch (error) { throw error; }
        }

        // Render metadata table
        function renderMetadata(metadata) {
            const tbody = document.getElementById('metadata-tbody');
            tbody.innerHTML = '';

            const priorityFields = [
                { key: 'title', label: 'Title' },
                { key: 'authors', label: 'Authors', isArray: true },
                { key: 'type', label: 'Type' },
                { key: 'source', label: 'Source', isArray: true },
                { key: 'sinta_link', label: 'Sinta', isSpecial: true }
            ];

            priorityFields.forEach(field => {
                if (metadata[field.key]) {
                    const row = document.createElement('tr');

                    if (field.isSpecial && field.key === 'sinta_link') {
                        row.innerHTML = `
                            <th scope="row" style="width: 20%;">${field.label}</th>
                            <td>
                                <a href="${metadata[field.key].url}" target="_blank" class="btn btn-sm btn-outline-primary mb-2">
                                    <i class="bi bi-link-45deg"></i> ${metadata[field.key].text}
                                </a>
                                <div class="text-break">
                                    <small class="text-muted">${metadata[field.key].url}</small>
                                </div>
                            </td>
                        `;
                    } else if (field.isArray) {
                        if (field.key === 'source') {
                            const sources = Array.isArray(metadata[field.key]) ? metadata[field.key] : [metadata[field.key]];
                            const itemsHtml = sources.map(src => {
                                const qBoth = encodeURIComponent(`(site:sinta.* OR site:scimagojr.com) ${src}`);
                                const safeSrc = escapeHtml(src);
                                return `
                                    <div class="d-flex align-items-center flex-wrap mb-2">
                                        <span class="me-2">${safeSrc}</span>
                                        <button type="button" class="btn btn-sm btn-outline-secondary me-2" data-copy="${safeSrc}" aria-label="Salin sumber">
                                            <i class="bi bi-clipboard"></i> Salin
                                        </button>
                                        <a class="btn btn-sm btn-outline-secondary" target="_blank" rel="noopener" href="https://www.google.com/search?q=${qBoth}">
                                            <i class="bi bi-search"></i> Cari Sinta dan Scimago di Google
                                        </a>
                                    </div>
                                `;
                            }).join('');

                            row.innerHTML = `
                                <th scope="row" style="width: 20%;">${field.label}</th>
                                <td>${itemsHtml}</td>
                            `;
                        } else {
                            row.innerHTML = `
                                <th scope="row" style="width: 20%;">${field.label}</th>
                                <td>${Array.isArray(metadata[field.key]) ? metadata[field.key].join(', ') : metadata[field.key]}</td>
                            `;
                        }
                    } else {
                        if (field.key === 'title') {
                            const titleSafe = escapeHtml(metadata[field.key]);
                            row.innerHTML = `
                                <th scope="row" style="width: 20%;">${field.label}</th>
                                <td>
                                    <div class="d-flex align-items-center flex-wrap">
                                        <span class="me-2">${titleSafe}</span>
                                        <button type="button" class="btn btn-sm btn-outline-secondary" data-copy="${titleSafe}" aria-label="Salin judul">
                                            <i class="bi bi-clipboard"></i> Salin
                                        </button>
                                    </div>
                                </td>
                            `;
                        } else {
                            row.innerHTML = `
                                <th scope="row" style="width: 20%;">${field.label}</th>
                                <td>${metadata[field.key]}</td>
                            `;
                        }
                    }

                    tbody.appendChild(row);
                }
            });

            Object.keys(metadata).forEach(key => {
                if (key.startsWith('date_')) {
                    const row = document.createElement('tr');
                    const dateLabel = key.replace('date_', '').charAt(0).toUpperCase() + key.replace('date_', '').slice(1);
                    row.innerHTML = `
                        <th scope="row" style="width: 20%;">${dateLabel} Date</th>
                        <td>${metadata[key]}</td>
                    `;
                    tbody.appendChild(row);
                }
            });
        }

        // Render additional information
        function renderAdditionalInfo(metadata) {
            const container = document.getElementById('additional-info');
            container.innerHTML = '';

            const additionalFields = [
                { key: 'uri', label: 'URI', isLink: true },
                { key: 'doi', label: 'DOI' },
                { key: 'issn', label: 'ISSN' },
                { key: 'volume', label: 'Volume' },
                { key: 'keywords', label: 'Keywords' },
                { key: 'language', label: 'Language' },
                { key: 'pdf_url', label: 'PDF', isPDF: true }
            ];

            additionalFields.forEach(field => {
                if (metadata[field.key]) {
                    const div = document.createElement('div');
                    div.className = 'mb-3';

                    if (field.isLink) {
                        if (field.key === 'uri') {
                            const linkSafe = escapeHtml(metadata[field.key]);
                            div.innerHTML = `
                                <strong>${field.label}:</strong>
                                <a href="${metadata[field.key]}" target="_blank">${metadata[field.key]}</a>
                                <button type="button" class="btn btn-sm btn-outline-secondary ms-2" data-copy="${linkSafe}" aria-label="Salin URL artikel">
                                    <i class="bi bi-clipboard"></i> Salin
                                </button>
                            `;
                        } else {
                            div.innerHTML = `
                                <strong>${field.label}:</strong>
                                <a href="${metadata[field.key]}" target="_blank">${metadata[field.key]}</a>
                            `;
                        }
                    } else if (field.isPDF) {
                        div.innerHTML = `
                            <strong>${field.label}:</strong>
                            <a href="${metadata[field.key]}" target="_blank" class="btn btn-sm btn-outline-success">
                                <i class="bi bi-file-pdf"></i> View PDF
                            </a>
                        `;
                    } else {
                        div.innerHTML = `
                            <strong>${field.label}:</strong>
                            <span>${metadata[field.key]}</span>
                        `;
                    }

                    container.appendChild(div);
                }
            });

            if (metadata.first_page || metadata.last_page) {
                const div = document.createElement('div');
                div.className = 'mb-3';
                let pages = '';
                if (metadata.first_page && metadata.last_page) {
                    pages = `${metadata.first_page}-${metadata.last_page}`;
                } else if (metadata.first_page) {
                    pages = metadata.first_page;
                } else if (metadata.last_page) {
                    pages = metadata.last_page;
                }
                div.innerHTML = `
                    <strong>Pages:</strong>
                    <span>${pages}</span>
                `;
                container.appendChild(div);
            }

            if (metadata.description_en) {
                const div = document.createElement('div');
                div.className = 'mb-4';
                div.innerHTML = `
                    <h5 class="card-title">English Abstract</h5>
                    <p class="card-text">${metadata.description_en}</p>
                `;
                container.appendChild(div);
            }

            if (metadata.description_id) {
                const div = document.createElement('div');
                div.innerHTML = `
                    <h5 class="card-title">Indonesian Abstract</h5>
                    <p class="card-text">${metadata.description_id}</p>
                `;
                container.appendChild(div);
            }
        }

        // Handle API response
        function handleAPIResponse(data) {
            hideError();
            
            // Show notices
            const citationNotice = document.getElementById('citation-notice');
            const waybackNotice = document.getElementById('wayback-notice');
            
            if (data.metadata.metadata_source === 'citation') {
                citationNotice.style.display = 'block';
            } else {
                citationNotice.style.display = 'none';
            }
            
            if (data.metadata.wayback_url) {
                document.getElementById('wayback-message').textContent = data.metadata.note;
                document.getElementById('wayback-link').href = data.metadata.wayback_url;
                waybackNotice.style.display = 'block';
            } else {
                waybackNotice.style.display = 'none';
            }

            // Render data
            renderMetadata(data.metadata);
            renderAdditionalInfo(data.metadata);

            // Start async Sinta fetch if available
            try {
                startSintaInfo(data.metadata);
            } catch (_) { /* ignore */ }
            // Start async SCImago fetch if available
            try {
                startScimagoInfo(data.metadata);
            } catch (_) { /* ignore */ }
            
            // Handle preview
            const previewFrame = document.getElementById('preview-frame');
            const noPreview = document.getElementById('no-preview');
            
            if (data.journal_url && !data.html_content) {
                previewFrame.src = data.journal_url;
                previewFrame.style.display = 'block';
                noPreview.style.display = 'none';
            } else if (data.html_content) {
                // Create blob URL for HTML content
                const blob = new Blob([data.html_content], { type: 'text/html' });
                const blobUrl = URL.createObjectURL(blob);
                previewFrame.src = blobUrl;
                previewFrame.style.display = 'block';
                noPreview.style.display = 'none';
            } else {
                previewFrame.style.display = 'none';
                noPreview.style.display = 'block';
            }

            // Show results
            welcomeMessage.style.display = 'none';
            resultsContainer.style.display = 'block';
            
            // Scroll to results
            resultsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });

            // Particle assemble animation over the metadata table (on reveal)
            try {
                const prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
                const targetTable = document.getElementById('metadata-table');
                if (targetTable && !prefersReduced) {
                    // Prepare for reveal
                    targetTable.classList.add('assemble-hide');
                    // Short delay to allow layout/scroll to settle
                    setTimeout(() => {
                        const animDuration = 600;
                        // Start particles
                        const animPromise = playParticleAssemble(targetTable, { color: '#00e676', accent: '#b8f269', duration: animDuration });
                        // Begin revealing the table slightly before particles finish for snappier feel
                        setTimeout(() => {
                            requestAnimationFrame(() => {
                                targetTable.classList.add('assemble-show');
                                setTimeout(() => targetTable.classList.remove('assemble-hide'), 30);
                            });
                        }, Math.min(400, Math.floor(animDuration * 0.6)));
                        // Ensure visibility even if animation ends earlier
                        animPromise.finally(() => {
                            targetTable.classList.add('assemble-show');
                            setTimeout(() => targetTable.classList.remove('assemble-hide'), 30);
                        });
                    }, 80);
                }
            } catch (_) { /* no-op */ }
        }

        // Extract Sinta ID from URL
        function extractSintaIdFromUrl(url) {
            if (!url || typeof url !== 'string') return null;
            try {
                // Quick query param match
                const q = url.match(/[?&]id=(\d+)(?:&|$)/i);
                if (q) return q[1];
                // Ensure protocol for URL parsing
                const ensured = /^(https?:)?\/\//i.test(url) ? (url.startsWith('http') ? url : 'https:' + url) : 'https://' + url;
                const u = new URL(ensured);
                const path = u.pathname.toLowerCase();
                // Match trailing numeric segment after /journal or /journals paths
                const m = path.match(/\/(?:journal|journals)\/(?:[^\/]*\/)*(\d+)(?:\/)?$/i);
                if (m) return m[1];
                return null;
            } catch (_) {
                // Fallback direct regex on raw string
                const m = url.toLowerCase().match(/\/(?:journal|journals)\/(?:[^\/]*\/)*(\d+)(?:\/|$)/i);
                if (m) return m[1];
                return null;
            }
        }

        // Async Sinta info loader
        async function startSintaInfo(metadata) {
            const card = document.getElementById('sinta-card');
            const loading = document.getElementById('sinta-loading');
            const content = document.getElementById('sinta-content');
            const errBox = document.getElementById('sinta-error');

            content.style.display = 'none';
            errBox.style.display = 'none';
            loading.style.display = 'none';
            card.style.display = 'none';

            if (!metadata || !metadata.sinta_link || !metadata.sinta_link.url) return;

            const sintaId = extractSintaIdFromUrl(metadata.sinta_link.url);
            if (!sintaId) return;

            card.style.display = 'block';
            loading.style.display = 'flex';

            try {
                const apiUrl = `https://sinta-journal-api-production.atiohaidar.workers.dev/api/journal/${encodeURIComponent(sintaId)}`;
                const resp = await fetch(apiUrl, { headers: { 'Accept': 'application/json' } });
                if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                const json = await resp.json();
                if (!json || json.success !== true || !json.data) throw new Error(json && json.message ? json.message : 'Invalid response');

                const nameEl = document.getElementById('sinta-name');
                const websiteEl = document.getElementById('sinta-website');
                const histEl = document.getElementById('sinta-accreditation-history');

                nameEl.textContent = json.data.name || '-';
                websiteEl.textContent = json.data.website_url || '-';
                if (json.data.website_url) websiteEl.href = json.data.website_url; else websiteEl.removeAttribute('href');

                histEl.innerHTML = '';
                const hist = json.data.accreditation_history || {};
                const years = Object.keys(hist).filter(y => /^(\d{4})$/.test(y)).sort((a,b) => b.localeCompare(a));

                // Extract any publication years from metadata
                const pubYears = new Set();
                try {
                    Object.keys(metadata || {}).forEach(k => {
                        if (k.startsWith('date') || k.startsWith('date_') || k === 'year') {
                            const val = String(metadata[k] || '');
                            const matches = val.match(/\b(19|20)\d{2}\b/g);
                            if (matches) matches.forEach(y => pubYears.add(y));
                        }
                    });
                } catch (_) { /* ignore */ }

                if (years.length === 0) {
                    histEl.innerHTML = '<span class="text-muted">No data</span>';
                } else {
                    const list = document.createElement('div');
                    years.forEach(y => {
                        const levelRaw = String(hist[y] || '').trim();
                        const level = levelRaw.toUpperCase();
                        const pill = document.createElement('span');
                        const matched = pubYears.has(y);
                        pill.className = `badge rounded-pill ${matched ? 'text-bg-success' : 'text-bg-secondary'} me-2 mb-2`;
                        pill.textContent = `${y}: ${level}`;
                        list.appendChild(pill);
                    });
                    histEl.appendChild(list);
                }

                content.style.display = 'block';
            } catch (e) {
                errBox.textContent = `Failed to load Sinta info: ${e.message}`;
                errBox.style.display = 'block';
            } finally {
                loading.style.display = 'none';
            }
        }

        // Async SCImago info loader
        async function startScimagoInfo(metadata) {
            const card = document.getElementById('scimago-card');
            const loading = document.getElementById('scimago-loading');
            const content = document.getElementById('scimago-content');
            const errBox = document.getElementById('scimago-error');
            const imgEl = document.getElementById('scimago-img');
            const nameEl = document.getElementById('scimago-name');
            const publisherEl = document.getElementById('scimago-publisher');
            const countryEl = document.getElementById('scimago-country');
            const typeEl = document.getElementById('scimago-type');
            const homepageEl = document.getElementById('scimago-homepage');
            const quartilesEl = document.getElementById('scimago-quartiles');

            // Reset state
            content.style.display = 'none';
            errBox.style.display = 'none';
            loading.style.display = 'none';
            card.style.display = 'none';
            imgEl.classList.add('d-none');

            if (!metadata || !metadata.scimago_info || !metadata.scimago_info.url) return;
            card.style.display = 'block';
            loading.style.display = 'flex';

            try {
                // Gunakan API scrape.scimago.workers.dev
                const apiUrl = 'https://scrape.scimago.workers.dev/';
                const resp = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: metadata.scimago_info.url.replace(/&amp;/g, '&') })
                });
                if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                const json = await resp.json();
                if (!json || !json.name) throw new Error('Data SCImago tidak ditemukan');
                // Isi UI
                nameEl.textContent = json.name || '-';
                publisherEl.textContent = json.publisher || '-';
                countryEl.textContent = json.country || '-';
                typeEl.textContent = json.publicationType || '-';
                homepageEl.textContent = json.homepage || '-';
                if (json.homepage) homepageEl.href = json.homepage; else homepageEl.removeAttribute('href');
                if (metadata.scimago_info.img) {
                    imgEl.src = metadata.scimago_info.img;
                    imgEl.classList.remove('d-none');
                } else {
                    imgEl.classList.add('d-none');
                }
                // Quartiles
                quartilesEl.innerHTML = '';
                // Ambil tahun-tahun dari metadata (seperti Sinta)
                const pubYears = new Set();
                try {
                    Object.keys(metadata || {}).forEach(k => {
                        if (k.startsWith('date') || k.startsWith('date_') || k === 'year') {
                            const val = String(metadata[k] || '');
                            const matches = val.match(/\b(19|20)\d{2}\b/g);
                            if (matches) matches.forEach(y => pubYears.add(y));
                        }
                    });
                } catch (_) { /* ignore */ }
                if (Array.isArray(json.quartiles) && json.quartiles.length > 0) {
                    const byYear = {};
                    json.quartiles.forEach(q => {
                        if (!byYear[q.year]) byYear[q.year] = [];
                        byYear[q.year].push(q);
                    });
                    const years = Object.keys(byYear).sort();
                    years.forEach(y => {
                        const yearDiv = document.createElement('div');
                        const highlight = pubYears.has(y);
                        yearDiv.className = 'mb-1';
                        yearDiv.innerHTML = `<span class="badge rounded-pill ${highlight ? 'text-bg-success' : 'text-bg-secondary'} me-2">${y}</span>` +
                            byYear[y].map(q => `<span class="badge bg-success me-1">${q.category}: ${q.quartile}</span>`).join(' ');
                        quartilesEl.appendChild(yearDiv);
                    });
                } else {
                    quartilesEl.innerHTML = '<span class="text-muted">Tidak ada data quartile.</span>';
                }
                content.style.display = 'block';
            } catch (e) {
                errBox.textContent = `Gagal memuat info SCImago: ${e.message}`;
                errBox.style.display = 'block';
            } finally {
                loading.style.display = 'none';
            }
        }

        // Form submission handlers
        document.getElementById('url-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            let journalUrl = document.getElementById('journal_url').value.trim().replace(/[\n\r]/g, '');
            if (journalUrl.startsWith('http://')) {
                journalUrl = 'https://' + journalUrl.slice(7);
                document.getElementById('journal_url').value = journalUrl;
            }
            if (!journalUrl) return;
            showLoading();
            try {
                const data = await callAPI('/api/extract-metadata', {
                    input_mode: 'url',
                    journal_url: journalUrl
                });
                
                handleAPIResponse(data);
            } catch (error) {
                showError(error.message);
            } finally {
                hideLoading();
            }
        });

        document.getElementById('html-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const htmlContent = document.getElementById('html_content').value.trim();
            const displayUrl = document.getElementById('display_url').value.trim();
            
            if (!htmlContent) return;

            showLoading();
            
            try {
                const data = await callAPI('/api/extract-metadata', {
                    input_mode: 'html',
                    html_content: htmlContent,
                    display_url: displayUrl
                });
                
                handleAPIResponse(data);
            } catch (error) {
                showError(error.message);
            } finally {
                hideLoading();
            }
        });
        // Simple global paste handler
        document.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && (e.key === 'v' || e.keyCode === 86)) {
                if (document.activeElement.tagName === 'INPUT' || 
                    document.activeElement.tagName === 'TEXTAREA') {
                    return;
                }
                const tempInput = document.createElement('textarea');
                tempInput.style.position = 'fixed';
                tempInput.style.opacity = '0';
                document.body.appendChild(tempInput);
                tempInput.focus();
                setTimeout(function() {
                    let pastedContent = tempInput.value.trim().replace(/[\n\r]/g, '');
                    document.body.removeChild(tempInput);
                    if (!pastedContent) return;
                    if (pastedContent.startsWith('http://')) {
                        pastedContent = 'https://' + pastedContent.slice(7);
                    }
                    const isURL = /^(https?:\/\/|www\.)/i.test(pastedContent);
                    if (isURL) {
                        document.getElementById('url-tab').click();
                        document.getElementById('journal_url').value = pastedContent;
                        showLoading();
                        callAPI('/api/extract-metadata', {
                            input_mode: 'url',
                            journal_url: pastedContent
                        }).then(handleAPIResponse).catch(error => {
                            showError(error.message);
                        }).finally(() => hideLoading());
                    } else if (pastedContent.length > 50) {
                        document.getElementById('html-tab').click();
                        document.getElementById('html_content').value = pastedContent;
                    } else {
                        alert("Konten yang ditempel tidak tampak seperti URL atau HTML. Silakan tempelkan langsung ke kolom yang sesuai.");
                    }
                }, 100);
            }
        });

        // Direct paste handler
        document.addEventListener('paste', function(e) {
            if (document.activeElement.tagName === 'INPUT' || 
                document.activeElement.tagName === 'TEXTAREA') {
                return;
            }
            let pastedContent = (e.clipboardData || window.clipboardData).getData('text');
            if (!pastedContent) return;
            e.preventDefault();
            if (pastedContent.startsWith('http://')) {
                pastedContent = 'https://' + pastedContent.slice(7);
            }
            const isURL = /^(https?:\/\/|www\.)/i.test(pastedContent);
            if (isURL) {
                document.getElementById('url-tab').click();
                document.getElementById('journal_url').value = pastedContent;
                showLoading();
                callAPI('/api/extract-metadata', {
                    input_mode: 'url',
                    journal_url: pastedContent
                }).then(handleAPIResponse).catch(error => {
                    showError(error.message);
                }).finally(() => hideLoading());
            } else if (pastedContent.length > 50) {
                document.getElementById('html-tab').click();
                document.getElementById('html_content').value = pastedContent;
            } else {
                alert("Konten yang ditempel tidak tampak seperti URL atau HTML. Silakan tempelkan langsung ke kolom yang sesuai.");
            }
        });

        // Show instruction notification
        document.addEventListener('DOMContentLoaded', function() {
            const notification = document.createElement('div');
            notification.className = 'alert alert-info alert-dismissible fade show';
            notification.innerHTML = '<strong>Tips!</strong> Tekan Ctrl+V di mana saja pada halaman ini untuk menempelkan konten secara otomatis, atau <strong>seret dan lepas</strong> tautan langsung ke halaman. URL akan langsung diproses, HTML akan ditempatkan di tab HTML. <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Tutup"></button>';
            document.querySelector('.container h1').after(notification);
        });

        // Drag and Drop functionality
        let dragCounter = 0;
        const dragOverlay = document.getElementById('dragOverlay');

        document.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.stopPropagation();
        });

        document.addEventListener('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
        });

        document.addEventListener('dragenter', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            dragCounter++;
            
            if (dragCounter === 1) {
                document.body.classList.add('drag-over');
                dragOverlay.classList.add('active');
            }
        });

        document.addEventListener('dragleave', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            dragCounter--;
            
            if (dragCounter === 0) {
                document.body.classList.remove('drag-over');
                dragOverlay.classList.remove('active');
            }
        });

        document.addEventListener('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            dragCounter = 0;
            document.body.classList.remove('drag-over');
            dragOverlay.classList.remove('active');

            let droppedData = e.dataTransfer.getData('text/plain') || e.dataTransfer.getData('text/uri-list');
            
            if (droppedData) {
                droppedData = droppedData.trim().replace(/[\n\r]/g, '');
                if (droppedData.startsWith('http://')) {
                    droppedData = 'https://' + droppedData.slice(7);
                }
                const isURL = /^(https?:\/\/|www\.)/i.test(droppedData);
                
                if (isURL) {
                    document.getElementById('url-tab').click();
                    document.getElementById('journal_url').value = droppedData;
                    showLoading();
                    callAPI('/api/extract-metadata', {
                        input_mode: 'url',
                        journal_url: droppedData
                    }).then(handleAPIResponse).catch(error => {
                        showError(error.message);
                    }).finally(() => hideLoading());
                } else if (droppedData.length > 50) {
                    document.getElementById('html-tab').click();
                    document.getElementById('html_content').value = droppedData;
                } else {
                    alert('Konten yang dijatuhkan tidak tampak seperti URL atau HTML.');
                }
            } else {
                alert('Tidak ada konten valid yang dijatuhkan. Silakan coba seret tautan atau teks.');
            }
        });

        // Particle assemble effect implementation
        function playParticleAssemble(targetEl, opts = {}) {
            return new Promise((resolve) => {
                const color = opts.color || '#00e676';
                const accent = opts.accent || '#b8f269';
                const duration = Math.max(400, Math.min(2000, opts.duration || 600));

                // Get bounding rect relative to document
                const rect = targetEl.getBoundingClientRect();
                const left = rect.left + window.scrollX;
                const top = rect.top + window.scrollY;
                const width = Math.max(10, Math.floor(rect.width));
                const height = Math.max(10, Math.floor(rect.height));

                // Create canvas overlay
                const canvas = document.createElement('canvas');
                canvas.width = width; canvas.height = height;
                canvas.className = 'assemble-canvas';
                canvas.style.left = left + 'px';
                canvas.style.top = top + 'px';
                document.body.appendChild(canvas);

                const ctx = canvas.getContext('2d');
                const area = width * height;
                const baseCount = Math.floor(area / 5000); // scale with area
                const count = Math.max(160, Math.min(600, baseCount));

                // Particles start from around edges and move into random points inside table bounds
                const margin = 40; // outside margin to spawn from
                const particles = new Array(count).fill(0).map((_, i) => {
                    // pick an edge: 0 top, 1 right, 2 bottom, 3 left
                    const edge = i % 4;
                    let sx, sy;
                    if (edge === 0) { sx = Math.random() * width; sy = -margin; }
                    else if (edge === 1) { sx = width + margin; sy = Math.random() * height; }
                    else if (edge === 2) { sx = Math.random() * width; sy = height + margin; }
                    else { sx = -margin; sy = Math.random() * height; }

                    const tx = Math.random() * width;
                    const ty = Math.random() * height;
                    const size = Math.random() * 1.8 + 0.8;
                    const life = duration + Math.random() * 280 - 140; // small variance
                    return { sx, sy, x: sx, y: sy, tx, ty, size, life, start: performance.now() + Math.random() * 60 };
                });

                const easeOutCubic = (t) => 1 - Math.pow(1 - t, 3);
                const draw = (now) => {
                    ctx.clearRect(0, 0, width, height);

                    let allDone = true;
                    // draw glow background faintly
                    // ctx.globalCompositeOperation = 'lighter';
                    for (let p of particles) {
                        const t = Math.min(1, Math.max(0, (now - p.start) / p.life));
                        const e = easeOutCubic(t);
                        p.x = p.sx + (p.tx - p.sx) * e;
                        p.y = p.sy + (p.ty - p.sy) * e;
                        const alpha = 0.15 + 0.85 * (1 - Math.abs(0.5 - e) * 2); // brighter mid-flight

                        // draw particle
                        ctx.beginPath();
                        ctx.fillStyle = `rgba(0, 230, 118, ${alpha})`;
                        ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                        ctx.fill();

                        // accent sparkle at end
                        if (e > 0.8) {
                            ctx.beginPath();
                            ctx.fillStyle = `rgba(184, 242, 105, ${0.4 * (e - 0.8) / 0.2})`;
                            ctx.arc(p.x, p.y, p.size * 1.6, 0, Math.PI * 2);
                            ctx.fill();
                        }

                        if (t < 1) allDone = false;
                    }

                    if (!allDone) {
                        requestAnimationFrame(draw);
                    } else {
                        // Fade out canvas and resolve
                        canvas.style.transition = 'opacity .2s ease';
                        canvas.style.opacity = '0';
                        setTimeout(() => {
                            canvas.remove();
                            resolve();
                        }, 210);
                    }
                };

                // Start animation and concurrently fade in target slightly delayed for cohesion
                requestAnimationFrame((ts) => {
                    // Subtle delayed fade-in of the target for cohesion
                    targetEl.style.willChange = 'opacity, transform';
                    setTimeout(() => {
                        targetEl.style.willChange = '';
                    }, duration + 500);
                    draw(ts);
                });
            });
        }
    </script>
</body>
</html>
